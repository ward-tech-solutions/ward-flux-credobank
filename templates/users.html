{% extends "base.html" %}
{% set show_sidebar = False %}

{% block title %}User Management - Network Monitoring{% endblock %}

{% block extra_css %}
<style>
    .users-page {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .page-title h1 {
        font-size: 28px;
        color: #1a1a1a;
        margin: 0;
    }

    .btn-add-user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-add-user:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    }

    .users-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
    }

    .users-table thead {
        background: #f8f9fa;
    }

    .users-table th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .users-table td {
        padding: 16px 20px;
        border-top: 1px solid #e9ecef;
        color: #495057;
    }

    .users-table tbody tr:hover {
        background: #f8f9fa;
    }

    .role-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .role-admin { background: #ffc107; color: #000; }
    .role-regional_manager { background: #17a2b8; color: white; }
    .role-technician { background: #28a745; color: white; }
    .role-viewer { background: #6c757d; color: white; }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-active { background: #d4edda; color: #155724; }
    .status-inactive { background: #f8d7da; color: #721c24; }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-edit, .btn-delete {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }

    .btn-edit {
        background: #e7f3ff;
        color: #0066cc;
    }

    .btn-edit:hover {
        background: #0066cc;
        color: white;
    }

    .btn-delete {
        background: #ffe7e7;
        color: #cc0000;
    }

    .btn-delete:hover {
        background: #cc0000;
        color: white;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s;
    }

    .modal-header {
        padding: 24px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 20px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6c757d;
    }

    .modal-body {
        padding: 24px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
    }

    .form-group input, .form-group select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
    }

    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .btn-cancel, .btn-save {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .btn-cancel {
        background: #e9ecef;
        color: #495057;
    }

    .btn-save {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .branch-selector {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 10px;
    }

    .branch-checkbox {
        display: flex;
        align-items: center;
        padding: 6px 0;
    }

    .branch-checkbox input {
        width: auto;
        margin-right: 8px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="users-page">
    <div class="page-header">
        <div class="page-title">
            <h1><i class="fas fa-users"></i> User Management</h1>
        </div>
        <button class="btn-add-user" onclick="openAddUserModal()">
            <i class="fas fa-plus"></i>
            Add New User
        </button>
    </div>

    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Region</th>
                    <th>Branches</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-tbody">
                <tr>
                    <td colspan="9" class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading users...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add New User</h2>
            <button class="modal-close" onclick="closeUserModal()">&times;</button>
        </div>
        <form id="userForm" onsubmit="saveUser(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" name="username" required>
                </div>

                <div class="form-group">
                    <label for="full_name">Full Name *</label>
                    <input type="text" id="full_name" name="full_name" required>
                </div>

                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="password">Password <span id="password-hint">(leave empty to keep current)</span></label>
                    <input type="password" id="password" name="password">
                </div>

                <div class="form-group">
                    <label for="role">Role *</label>
                    <select id="role" name="role" required onchange="handleRoleChange()">
                        <option value="viewer">Viewer</option>
                        <option value="technician">Technician</option>
                        <option value="regional_manager">Regional Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="form-group" id="region-group">
                    <label for="region">Region</label>
                    <select id="region" name="region">
                        <option value="">All Regions</option>
                        <option value="Tbilisi">Tbilisi</option>
                        <option value="Kvemo Kartli">Kvemo Kartli</option>
                        <option value="Kakheti">Kakheti</option>
                        <option value="Mtskheta-Mtianeti">Mtskheta-Mtianeti</option>
                        <option value="Samtskhe-Javakheti">Samtskhe-Javakheti</option>
                        <option value="Shida Kartli">Shida Kartli</option>
                        <option value="Imereti">Imereti</option>
                        <option value="Samegrelo">Samegrelo</option>
                        <option value="Guria">Guria</option>
                        <option value="Achara">Achara</option>
                    </select>
                </div>

                <div class="form-group" id="branches-group">
                    <label>Assign Branches (optional)</label>
                    <div class="branch-selector" id="branch-selector">
                        <p style="text-align: center; color: #6c757d;">Loading branches...</p>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeUserModal()">Cancel</button>
                <button type="submit" class="btn-save">
                    <i class="fas fa-save"></i> Save User
                </button>
            </div>
        </form>
    </div>
</div>

<script src="{{ url_for('static', filename='js/auth.js') }}"></script>
<script>
let editingUserId = null;
let allBranches = [];

// Load users on page load
document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    loadBranches();
});

async function loadUsers() {
    try {
        const response = await auth.fetch('/api/v1/users');
        const users = await response.json();

        const tbody = document.getElementById('users-tbody');

        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>No users found. Click "Add New User" to create one.</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = users.map(user => `
            <tr>
                <td><strong>${user.username}</strong></td>
                <td>${user.full_name}</td>
                <td>${user.email}</td>
                <td><span class="role-badge role-${user.role}">${user.role.replace('_', ' ').toUpperCase()}</span></td>
                <td>${user.region || '-'}</td>
                <td>${user.branches ? user.branches.split(',').length + ' branches' : '-'}</td>
                <td><span class="status-badge status-${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-edit" onclick="editUser(${user.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-delete" onclick="deleteUser(${user.id}, '${user.username}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading users:', error);
        alert('Failed to load users. Please try again.');
    }
}

async function loadBranches() {
    try {
        const response = await auth.fetch('/api/devices');
        const devices = await response.json();

        // Extract unique branch names
        const branchesSet = new Set();
        devices.forEach(device => {
            if (device.branch) {
                branchesSet.add(device.branch);
            }
        });

        allBranches = Array.from(branchesSet).sort();
        updateBranchSelector();
    } catch (error) {
        console.error('Error loading branches:', error);
    }
}

function updateBranchSelector() {
    const selector = document.getElementById('branch-selector');
    if (allBranches.length === 0) {
        selector.innerHTML = '<p style="text-align: center; color: #6c757d;">No branches available</p>';
        return;
    }

    selector.innerHTML = allBranches.map(branch => `
        <div class="branch-checkbox">
            <input type="checkbox" id="branch-${branch}" name="branches" value="${branch}">
            <label for="branch-${branch}">${branch}</label>
        </div>
    `).join('');
}

function openAddUserModal() {
    editingUserId = null;
    document.getElementById('modalTitle').textContent = 'Add New User';
    document.getElementById('password-hint').style.display = 'none';
    document.getElementById('userForm').reset();
    document.getElementById('userModal').classList.add('show');

    // Uncheck all branches
    document.querySelectorAll('input[name="branches"]').forEach(cb => cb.checked = false);
}

async function editUser(userId) {
    try {
        const response = await auth.fetch('/api/v1/users');
        const users = await response.json();
        const user = users.find(u => u.id === userId);

        if (!user) return;

        editingUserId = userId;
        document.getElementById('modalTitle').textContent = 'Edit User';
        document.getElementById('password-hint').style.display = 'inline';

        document.getElementById('username').value = user.username;
        document.getElementById('full_name').value = user.full_name;
        document.getElementById('email').value = user.email;
        document.getElementById('password').value = '';
        document.getElementById('role').value = user.role;
        document.getElementById('region').value = user.region || '';

        // Check assigned branches
        document.querySelectorAll('input[name="branches"]').forEach(cb => cb.checked = false);
        if (user.branches) {
            const userBranches = user.branches.split(',');
            userBranches.forEach(branch => {
                const checkbox = document.getElementById(`branch-${branch.trim()}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        handleRoleChange();
        document.getElementById('userModal').classList.add('show');
    } catch (error) {
        console.error('Error loading user:', error);
        alert('Failed to load user details.');
    }
}

function closeUserModal() {
    document.getElementById('userModal').classList.remove('show');
}

async function saveUser(event) {
    event.preventDefault();

    const formData = new FormData(event.target);

    // Get selected branches
    const selectedBranches = Array.from(document.querySelectorAll('input[name="branches"]:checked'))
        .map(cb => cb.value);

    const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        full_name: formData.get('full_name'),
        password: formData.get('password') || 'temppass123', // Required for create
        role: formData.get('role'),
        region: formData.get('region') || null,
        branches: selectedBranches.length > 0 ? selectedBranches.join(',') : null
    };

    try {
        let response;
        if (editingUserId) {
            response = await auth.fetch(`/api/v1/users/${editingUserId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
        } else {
            response = await auth.fetch('/api/v1/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
        }

        if (response.ok) {
            closeUserModal();
            loadUsers();
            alert(editingUserId ? 'User updated successfully!' : 'User created successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to save user'));
        }
    } catch (error) {
        console.error('Error saving user:', error);
        alert('Failed to save user. Please try again.');
    }
}

async function deleteUser(userId, username) {
    if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
        return;
    }

    try {
        const response = await auth.fetch(`/api/v1/users/${userId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            loadUsers();
            alert('User deleted successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to delete user'));
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        alert('Failed to delete user. Please try again.');
    }
}

function handleRoleChange() {
    const role = document.getElementById('role').value;
    const regionGroup = document.getElementById('region-group');
    const branchesGroup = document.getElementById('branches-group');

    // Show region/branches for regional managers and technicians
    if (role === 'regional_manager' || role === 'technician') {
        regionGroup.style.display = 'block';
        branchesGroup.style.display = 'block';
    } else {
        regionGroup.style.display = 'none';
        branchesGroup.style.display = 'none';
    }
}

// Close modal when clicking outside
document.getElementById('userModal').addEventListener('click', (e) => {
    if (e.target.id === 'userModal') {
        closeUserModal();
    }
});
</script>
{% endblock %}
