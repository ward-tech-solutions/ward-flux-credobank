{% extends "base.html" %}
{% set show_sidebar = False %}

{% block title %}Network Topology - WARD OPS{% endblock %}

{% block content %}
<div class="topology-page-wrapper">
    <!-- Top Toolbar -->
    <div class="topology-toolbar">
        <div class="toolbar-left">
            <h1><i class="fas fa-project-diagram"></i> Network Topology</h1>
        </div>

        <div class="toolbar-center">
            <input type="text" id="search-box" class="search-input" placeholder="Search devices, IP addresses..." />
        </div>

        <div class="toolbar-right">
            <button class="control-btn" onclick="zoomIn()" title="Zoom In">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="control-btn" onclick="zoomOut()" title="Zoom Out">
                <i class="fas fa-search-minus"></i>
            </button>
            <button class="control-btn" onclick="resetView()" title="Reset View">
                <i class="fas fa-compress-arrows-alt"></i>
            </button>
            <button class="control-btn" onclick="toggleFullscreen()" title="Fullscreen">
                <i class="fas fa-expand"></i>
            </button>
        </div>
    </div>

    <!-- Performance Metrics Dashboard - Hidden -->
    <div class="metrics-dashboard" style="display: none;">
        <div class="metric-card">
            <div class="metric-icon" style="background: rgba(94, 187, 168, 0.2);">
                <i class="fas fa-exchange-alt" style="color: var(--ward-green);"></i>
            </div>
            <div class="metric-info">
                <div class="metric-label">Total Bandwidth</div>
                <div class="metric-value" id="total-bandwidth">0 Gbps</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: rgba(59, 130, 246, 0.2);">
                <i class="fas fa-tachometer-alt" style="color: #3b82f6;"></i>
            </div>
            <div class="metric-info">
                <div class="metric-label">Busiest Interface</div>
                <div class="metric-value" id="busiest-interface">-</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: rgba(239, 68, 68, 0.2);">
                <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
            </div>
            <div class="metric-info">
                <div class="metric-label">Devices with Errors</div>
                <div class="metric-value" id="error-count">0</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: rgba(245, 158, 11, 0.2);">
                <i class="fas fa-history" style="color: var(--warning);"></i>
            </div>
            <div class="metric-info">
                <div class="metric-label">Status Changes</div>
                <div class="metric-value" id="status-changes">0 recent</div>
            </div>
        </div>
    </div>

    <!-- Filter & Stats Bar -->
    <div class="filter-stats-bar">
        <div class="filters-section">
            <label class="filter-label">
                <input type="checkbox" id="filter-routers" checked onchange="applyFilters()">
                <span>Routers</span>
            </label>
            <label class="filter-label">
                <input type="checkbox" id="filter-switches" checked onchange="applyFilters()">
                <span>Switches</span>
            </label>
            <label class="filter-label">
                <input type="checkbox" id="filter-payboxes" checked onchange="applyFilters()">
                <span>Payboxes</span>
            </label>
            <div class="filter-divider"></div>
            <label class="filter-label" style="min-width: 250px;">
                <span style="margin-right: 8px;">Core Devices:</span>
                <select id="core-device-selector" multiple onchange="setCoreDevices()" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; height: 60px; min-width: 180px;">
                </select>
            </label>
            <div class="filter-divider"></div>
            <label class="filter-label">
                <input type="checkbox" id="filter-online" checked onchange="applyFilters()">
                <span>Online</span>
            </label>
            <label class="filter-label">
                <input type="checkbox" id="filter-offline" checked onchange="applyFilters()">
                <span>Offline</span>
            </label>
        </div>

        <div class="stats-section">
            <div class="stat-item">
                <i class="fas fa-circle-notch"></i>
                <span><strong id="total-nodes">0</strong> Nodes</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-link"></i>
                <span><strong id="total-edges">0</strong> Links</span>
            </div>
            <div class="stat-item stat-online">
                <i class="fas fa-check-circle"></i>
                <span><strong id="online-count">0</strong> Online</span>
            </div>
            <div class="stat-item stat-offline">
                <i class="fas fa-times-circle"></i>
                <span><strong id="offline-count">0</strong> Offline</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="topology-workspace">
        <!-- Topology Canvas -->
        <div id="topology-canvas" class="topology-canvas"></div>

        <!-- Legend -->
        <div class="topology-legend">
            <h4>Legend</h4>
            <div class="legend-item">
                <span class="legend-dot" style="background: #FF6B35;"></span>
                <span>Core Router</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot" style="background: #14b8a6;"></span>
                <span>Branch Switch</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot" style="background: #5EBBA8;"></span>
                <span>Online</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot" style="background: #ef4444;"></span>
                <span>Offline</span>
            </div>
        </div>

        <!-- Mini Map -->
        <div class="mini-map" id="mini-map">
            <div class="mini-map-header">
                <span><i class="fas fa-map"></i> Overview</span>
                <button onclick="toggleMiniMap()" class="mini-map-toggle" title="Hide mini-map">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <canvas id="mini-map-canvas" width="350" height="260"></canvas>
        </div>

        <!-- Device Details Panel -->
        <div id="details-panel" class="details-panel" style="display: none;">
            <div class="panel-header">
                <h3 id="panel-title">Device Details</h3>
                <button class="close-btn" onclick="closeDetailsPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="panel-content" id="panel-content">
                <div class="empty-state">
                    <i class="fas fa-mouse-pointer"></i>
                    <p>Click on a device to view details</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading network topology...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
<script src="{{ url_for('static', filename='js/topology.js') }}?v=9"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.css">
<style>
/* WARD Topology Styles */
/* Dark mode (default) */
:root,
:root[data-theme="dark"],
html[data-theme="dark"],
html[data-theme="dark"] body {
    --ward-green: #5EBBA8;
    --ward-green-light: #72CFB8;
    --ward-green-dark: #4A9D8A;
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #1c2128;
    --border-color: #21262d;
    --text-primary: #F3F4F6;
    --text-secondary: #9CA3AF;
    --danger: #ef4444;
    --warning: #f59e0b;
    --canvas-bg: #0d1117;
    --minimap-bg: #161b22;
    --edge-color: #30363d;
}

/* Light mode */
:root[data-theme="light"],
html[data-theme="light"],
html[data-theme="light"] body {
    --ward-green: #5EBBA8;
    --ward-green-light: #72CFB8;
    --ward-green-dark: #4A9D8A;
    --bg-primary: #ffffff;
    --bg-secondary: #f8f9fa;
    --bg-tertiary: #e9ecef;
    --border-color: #dee2e6;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --danger: #dc3545;
    --warning: #ffc107;
    --canvas-bg: #f8f9fa;
    --minimap-bg: #ffffff;
    --edge-color: #adb5bd;
}

.topology-page-wrapper {
    width: 100%;
    height: 100vh;
    background: var(--bg-primary);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Toolbar */
.topology-toolbar {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 2rem;
}

.toolbar-left h1 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.toolbar-left h1 i {
    color: var(--ward-green);
}

.toolbar-center {
    flex: 1;
    max-width: 500px;
}

.search-input {
    width: 100%;
    padding: 0.625rem 1rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.search-input:focus {
    outline: none;
    border-color: var(--ward-green);
    box-shadow: 0 0 0 3px rgba(94, 187, 168, 0.1);
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.control-select {
    padding: 0.5rem 1rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.875rem;
    cursor: pointer;
}

.control-select:focus {
    outline: none;
    border-color: var(--ward-green);
}

.control-btn {
    width: 36px;
    height: 36px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.control-btn:hover {
    background: var(--bg-primary);
    color: var(--ward-green);
    border-color: var(--ward-green);
    transform: translateY(-1px);
}

/* Performance Metrics Dashboard */
.metrics-dashboard {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 1rem 1.5rem;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.metric-card {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.2s;
}

.metric-card:hover {
    border-color: var(--ward-green);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.metric-info {
    flex: 1;
}

.metric-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.metric-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

/* Filter & Stats Bar */
.filter-stats-bar {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2rem;
}

.filters-section {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.filter-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    cursor: pointer;
    user-select: none;
}

.filter-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--ward-green);
}

.filter-label:hover {
    color: var(--text-primary);
}

.filter-divider {
    width: 1px;
    height: 20px;
    background: var(--border-color);
}

.stats-section {
    display: flex;
    gap: 2rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.stat-item i {
    color: var(--ward-green);
}

.stat-item strong {
    color: var(--text-primary);
    font-weight: 700;
}

.stat-item.stat-online i {
    color: var(--ward-green);
}

.stat-item.stat-offline i {
    color: var(--danger);
}

/* Workspace */
.topology-workspace {
    flex: 1;
    position: relative;
    overflow: hidden;
}

.topology-canvas {
    width: 100%;
    height: 100%;
    background: var(--bg-primary);
}

/* Legend */
.topology-legend {
    position: absolute;
    bottom: 2rem;
    left: 2rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    min-width: 180px;
}

.topology-legend h4 {
    margin: 0 0 0.75rem 0;
    font-size: 0.875rem;
    color: var(--text-primary);
    font-weight: 700;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    font-size: 0.8125rem;
    color: var(--text-secondary);
}

.legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
}

/* Mini Map */
.mini-map {
    position: absolute;
    bottom: 2rem;
    left: 2rem;
    background: var(--bg-secondary);
    border: 1px solid var(--ward-green);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(94, 187, 168, 0.3);
    z-index: 100;
}

.mini-map-header {
    padding: 0.5rem 0.75rem;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
}

.mini-map-toggle {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 3px;
}

.mini-map-toggle:hover {
    background: var(--bg-primary);
    color: var(--ward-green);
}

#mini-map-canvas {
    display: block;
    background: var(--bg-primary);
    cursor: pointer;
    transition: opacity 0.2s;
}

#mini-map-canvas:hover {
    opacity: 0.9;
    outline: 2px solid var(--ward-green);
    outline-offset: -2px;
}

/* Details Panel */
.details-panel {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 380px;
    max-height: calc(100vh - 250px);
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
}

.panel-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.panel-header h3 {
    margin: 0;
    font-size: 1rem;
    color: var(--text-primary);
}

.close-btn {
    width: 32px;
    height: 32px;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.close-btn:hover {
    background: var(--danger);
    color: white;
}

.panel-content {
    padding: 1.25rem;
    overflow-y: auto;
    flex: 1;
}

.panel-content::-webkit-scrollbar {
    width: 6px;
}

.panel-content::-webkit-scrollbar-track {
    background: var(--bg-primary);
}

.panel-content::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

.panel-content::-webkit-scrollbar-thumb:hover {
    background: var(--ward-green);
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
    text-align: center;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Loading Overlay */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(13, 17, 23, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(94, 187, 168, 0.1);
    border-top-color: var(--ward-green);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 1.5rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-overlay p {
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 600;
}

/* Info Sections */
.info-section {
    margin-bottom: 1.25rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-color);
    border-radius: 6px;
}

.info-section:hover {
    border-color: var(--ward-green);
}

.info-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.info-value {
    color: var(--text-primary);
    font-size: 0.9375rem;
}

.status-badge {
    padding: 0.375rem 0.875rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.status-badge.online {
    background: rgba(94, 187, 168, 0.15);
    color: var(--ward-green);
    border: 1px solid rgba(94, 187, 168, 0.3);
}

.status-badge.offline {
    background: rgba(239, 68, 68, 0.15);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.interface-summary {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
}

.summary-card {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 1rem;
    text-align: center;
}

.summary-label {
    font-size: 0.6875rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    margin-bottom: 0.5rem;
}

.summary-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.summary-value.success {
    color: var(--ward-green);
}

.summary-value.danger {
    color: var(--danger);
}

.interface-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.interface-card {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-left: 3px solid var(--border-color);
    border-radius: 6px;
    padding: 1rem;
    transition: all 0.2s;
}

.interface-card:hover {
    border-left-color: var(--ward-green);
    transform: translateX(3px);
}

.interface-card.up {
    border-left-color: var(--ward-green);
}

.interface-card.down {
    border-left-color: var(--danger);
}

.interface-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.interface-name {
    font-weight: 700;
    color: var(--text-primary);
}

.interface-status {
    padding: 0.25rem 0.625rem;
    border-radius: 4px;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
}

.interface-status.up {
    background: rgba(94, 187, 168, 0.2);
    color: var(--ward-green);
}

.interface-status.down {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
}

.interface-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.metric {
    color: var(--text-secondary);
}

.metric strong {
    color: var(--ward-green);
}

.live-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: rgba(94, 187, 168, 0.1);
    border: 1px solid rgba(94, 187, 168, 0.3);
    border-radius: 6px;
    margin-bottom: 1rem;
    color: var(--ward-green);
    font-size: 0.8125rem;
    font-weight: 600;
}

.pulse-dot {
    width: 8px;
    height: 8px;
    background: var(--ward-green);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.9); }
}
</style>

<script>
// Populate core device selector
function populateCoreDeviceSelector() {
    const selector = document.getElementById('core-device-selector');
    if (!selector || !window.allNodes) return;

    // Clear existing options
    selector.innerHTML = '';

    // Get all devices
    const devices = allNodes.get();
    devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.id;
        option.textContent = device.label || device.id;
        selector.appendChild(option);
    });

    // Set current core devices if exists
    const coreDevices = JSON.parse(localStorage.getItem('core_device_ids') || '[]');
    Array.from(selector.options).forEach(option => {
        if (coreDevices.includes(option.value)) {
            option.selected = true;
        }
    });
}

// Set core devices (multiple selection)
function setCoreDevices() {
    const selector = document.getElementById('core-device-selector');
    const selectedIds = Array.from(selector.selectedOptions).map(opt => opt.value);

    // Save to localStorage
    localStorage.setItem('core_device_ids', JSON.stringify(selectedIds));

    // Update all nodes
    const devices = allNodes.get();
    devices.forEach(device => {
        if (selectedIds.includes(device.id)) {
            device.level = 0;
            device.deviceType = 'Core Router';
        } else if (device.level === 0 && device.deviceType === 'Core Router') {
            device.level = 1; // Reset non-selected core devices
            delete device.deviceType;
        }
    });
    allNodes.update(devices);

    // Redraw topology
    if (typeof applyLayout === 'function') {
        applyLayout();
    }
}

// Call this after topology loads
if (typeof window.addEventListener !== 'undefined') {
    window.addEventListener('topologyLoaded', populateCoreDeviceSelector);
}
</script>

{% endblock %}
