{% extends "base.html" %}
{% set show_sidebar = True %}

{% block title %}Devices - Network Monitoring{% endblock %}

{% block content %}
<div class="devices-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <h1>All Devices</h1>
        </div>
        <div class="page-actions">
            <div class="view-switch">
                <button class="view-btn active" data-view="table" onclick="switchView('table')">
                    <i class="fas fa-table"></i>
                    <span>Table</span>
                </button>
                <button class="view-btn" data-view="honeycomb" onclick="switchView('honeycomb')">
                    <i class="fas fa-th"></i>
                    <span>Cards</span>
                </button>
            </div>

            <div class="search-wrapper">
                <input type="search" id="search-input" class="search-box" name="search-devices-xyz" placeholder="Search devices, IP, branch..." autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" readonly onfocus="this.removeAttribute('readonly')">
                <i class="fas fa-search search-icon"></i>
                <button class="btn-advanced-search" onclick="toggleAdvancedSearch()">
                    <i class="fas fa-filter"></i> Filters
                </button>
            </div>

            <select id="filter-status" class="filter-dropdown">
                <option value="">All Status</option>
                <option value="Up">Online</option>
                <option value="Down">Offline</option>
                <option value="Unknown">Unknown</option>
            </select>

            <select id="filter-type" class="filter-dropdown">
                <option value="">All Types</option>
                <option value="Paybox">Paybox</option>
                <option value="ATM">ATM</option>
                <option value="NVR">NVR</option>
                <option value="Access Point">Access Point</option>
                <option value="Switch">Switch</option>
                <option value="Router">Router</option>
            </select>

            <button class="btn-add" onclick="window.location.href='/add-host'">
                <i class="fas fa-plus"></i>
                <span>Add Device</span>
            </button>
        </div>
    </div>

    <!-- Table View -->
    <div class="card" id="table-view">
        <div class="card-content no-padding">
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Device Name</th>
                            <th>Branch</th>
                            <th>IP Address</th>
                            <th>Type</th>
                            <th>Groups</th>
                            <th>Problems</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="devices-body">
                        <tr><td colspan="8" class="loading-cell">Loading devices...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Honeycomb View -->
    <div class="card" id="honeycomb-view" style="display: none;">
        <div class="card-content">
            <div class="honeycomb-grid" id="honeycomb-container"></div>
        </div>
    </div>
</div>

<!-- Device Modal -->
<div id="device-modal" class="modal" style="display: none;" onclick="closeModal(event)">
    <div class="modal-dialog" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="modal-title">Device Details</h2>
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="modal-body">
            <div class="loading-state">
                <div class="spinner"></div>
                <span>Loading device information...</span>
            </div>
        </div>
    </div>
</div>

<!-- SSH Terminal Modal -->
<div id="ssh-modal" class="modal" style="display: none;" onclick="closeSSHModal(event)">
    <div class="modal-dialog" onclick="event.stopPropagation()" style="max-width: 1000px;">
        <div class="modal-header">
            <h2><i class="fas fa-terminal" style="color: var(--ward-green);"></i> SSH Terminal - <span id="ssh-device-name"></span></h2>
            <button class="modal-close" onclick="closeSSHModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div id="ssh-terminal" style="height: 600px; background: #1e1e1e; display: flex; align-items: center; justify-content: center; color: #888;">
                <div style="text-align: center;">
                    <i class="fas fa-terminal" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                    <p>Enter credentials below and click Connect</p>
                </div>
            </div>
            <div style="padding: 1rem; background: var(--bg-secondary); border-top: 1px solid var(--border-light);">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input type="text" id="ssh-username" placeholder="Username (default: admin)" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-light); border-radius: 6px;">
                    <input type="password" id="ssh-password" placeholder="Password" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-light); border-radius: 6px;">
                    <button class="btn-add" onclick="connectSSH()" id="ssh-connect-btn">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
                <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">
                    <i class="fas fa-info-circle"></i> Enter credentials and click Connect to access the device terminal
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Edit Device Modal -->
<div id="edit-modal" class="modal" style="display: none;" onclick="closeEditModal(event)">
    <div class="modal-dialog" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2><i class="fas fa-edit" style="color: var(--ward-green);"></i> Edit Device</h2>
            <button class="modal-close" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="edit-modal-body">
            <div id="edit-loading" class="loading-state">
                <div class="spinner"></div>
                <span>Loading device information...</span>
            </div>
            <div id="edit-form" style="display: none;">
                <div id="edit-alert" class="alert" style="display: none;"></div>

                <form id="device-edit-form" onsubmit="handleDeviceUpdate(event)">
                    <input type="hidden" id="edit-hostid">

                    <div class="form-group">
                        <label for="edit-hostname">Hostname *</label>
                        <input type="text" id="edit-hostname" required placeholder="e.g., Tbilisi-Switch-01">
                        <small>Technical hostname for Zabbix (must be unique)</small>
                    </div>

                    <div class="form-group">
                        <label for="edit-visible-name">Display Name *</label>
                        <input type="text" id="edit-visible-name" required placeholder="e.g., Tbilisi Branch Switch 1">
                        <small>Friendly name shown in interface</small>
                    </div>

                    <div class="form-group">
                        <label for="edit-ip">IP Address *</label>
                        <input type="text" id="edit-ip" required pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" placeholder="e.g., 192.168.1.100">
                        <small>Must be a valid IPv4 address</small>
                    </div>

                    <div class="form-group">
                        <label for="edit-branch">Branch / City *</label>
                        <select id="edit-branch" required>
                            <option value="">Loading cities...</option>
                        </select>
                        <small>Select the branch/city where this device is located</small>
                    </div>

                    <div class="form-actions" style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                        <button type="button" class="btn-secondary" onclick="closeEditModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn-add" id="update-btn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/devices.js') }}?v=9"></script>
<script src="{{ url_for('static', filename='js/device-modal.js') }}?v=7"></script>
<script src="{{ url_for('static', filename='js/device-edit.js') }}?v=1"></script>
<script src="{{ url_for('static', filename='js/ssh-terminal.js') }}?v=1"></script>
<script>
// Clear search input on page load to prevent autofill
window.addEventListener('load', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.value = '';
    }
});
</script>
{% endblock %}